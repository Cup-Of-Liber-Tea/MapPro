<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ tourist.name }} - Naver Maps</title>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=xhqofn9jhr"></script>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/markerclusterer.js"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #map {
            width: 45%;
            height: 350px;
            margin: 20px 0;
        }

        #logger {
            margin-top: 10px;
            font-size: 16px;
        }

        .infowindow {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>{{ tourist.name }}</h1>

    {% if tourist.image %}
        <img src="{{ tourist.image.url }}" alt="{{ tourist.name }}" style="width: 200px; height: auto; margin: 10px;">
    {% endif %}

    <p><strong>설명:</strong> {{ tourist.description }}</p>
    <p><strong>위치:</strong> {{ tourist.location }}</p>
    <p><strong>운영 시간:</strong> {{ tourist.operating_hours|default:"전화문의" }}</p>
    <p><strong>입장료:</strong> {{ tourist.entrance_fee|default:"홈페이지문의" }}</p>
    <p><strong>주차정보:</strong> {{ tourist.parking|default:"전화문의" }}</p>

    <div id="map"></div>
    <div id="logger"></div>

    <script>
        // 경주 위치
        const kyungjuLocation = {
            latitude: 35.8393, // 경주 위도
            longitude: 129.2279 // 경주 경도
        };

        // API URL
        const apiUrl = "http://apis.data.go.kr/5050000/dstrctsTrrsrtService/getDstrctsTrrsrt";
        const params = {
            serviceKey: "0OqIh/dSuVpGLLplebEorV4PTg6OC2ht/iiVg0ZabhBfKsX2EJwtAoizU3JjdH/uNz6G/800CT8f6YWfbI8v6w==",
            pageNo: "1",
            numOfRows: "164"
        };

        // API 호출 함수
        async function fetchTouristSpots() {
            const response = await fetch(`${apiUrl}?${new URLSearchParams(params)}`);
            if (!response.ok) {
                throw new Error("API 호출 실패: " + response.status);
            }
            const data = await response.json();
            return data;
        }

        // 마커 추가 및 지도 초기화 함수
        function initMap(items) {
            // tourist.name과 일치하는 타이틀 찾기
            const touristName = "{{ tourist.name }}";
            const matchingItem = items.find(item => item.CON_TITLE === touristName);

            if (matchingItem && matchingItem.CON_LATITUDE && matchingItem.CON_LONGITUDE) {
                // 마커를 기준으로 지도를 설정합니다.
                const markerPosition = new naver.maps.LatLng(matchingItem.CON_LATITUDE, matchingItem.CON_LONGITUDE);

                var mapOptions = {
                    center: markerPosition, // 마커 위치로 중심 설정
                    zoom: 15 // 15로 설정하면 약 300m 범위를 표시
                };

                var map = new naver.maps.Map('map', mapOptions);

                // 마커 추가
                var marker = new naver.maps.Marker({
                    position: markerPosition,
                    map: map,
                    title: matchingItem.CON_TITLE
                });

                var infoWindow = new naver.maps.InfoWindow({
                    content: `<h4>${matchingItem.CON_TITLE}</h4>`
                });

                // 마커 클릭 시 정보 창 표시
                naver.maps.Event.addListener(marker, 'click', function() {
                    infoWindow.open(map, marker);
                });
            } else {
                console.error("관광지를 찾을 수 없습니다.");
                document.getElementById('logger').innerText = '관광지를 찾을 수 없습니다.';
            }
        }

        // API에서 관광지 정보 가져오기
        fetchTouristSpots()
            .then(data => {
                if (data.response && data.response.body && data.response.body.items) {
                    const items = data.response.body.items.item; // 올바른 데이터 접근
                    initMap(items);
                } else {
                    console.error("데이터 구조가 예상과 다릅니다.");
                }
            })
            .catch(error => console.error('데이터 로드 중 오류 발생:', error));
    </script>
    <h2>리뷰 목록</h2>
    {% if reviews %}
        <ul>
            {% for review in reviews %}
                <li>
                    <a href="{% url 'post_detail' review.id %}">{{ review.author }}: {{ review.title }}</a>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>작성된 리뷰가 없습니다.</p>
    {% endif %}
    <a href="{% url 'tourist_list' %}">목록으로 돌아가기</a>
</body>
</html>