{% extends 'base.html' %}
{% load static %}
{% block content %}
<script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=xhqofn9jhr"></script>
<script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/markerclusterer.js"></script>
<link rel="stylesheet" href="{% static 'user/css/detail2.css' %}">

<div class="post-detail-container">
  <h2 class="post-title">{{ object.title }}</h2>

  <!-- <div class="form-group">
      <label for="sele">선택</label>
      {{ object.sele }}
    </div> -->

  <div class="post-content">
    <p>{{ object.content }}</p>
  </div>

  <p class="post-location">Location: {{ object.location }}</p>

  {% if object.image %}
  <img class="post-image" src="{{ object.image.url }}" alt="Image for {{ object.title }}">
  {% endif %}

  <p class="post-author">Author: {{ object.author }}</p>
  <p class="post-created-at">Created at: {{ object.created_at }}</p>

  {% if request.user.username == object.author %}
  <a href="{% url 'post-edit' object.pk %}">Edit</a> |
  <a href="{% url 'post-delete' object.pk %}">Delete</a> <br>
  {% endif %}

  <!-- <div id="map" style="width:100%;height:500px;"></div>
  <div id="tourist-spots-list"></div> -->

  <a class="back-link" href="{% url 'post-list' %}">Back to list</a>
</div>

<!-- <script>
  var map;
var markers = [];
var userLocation;

function initMap() {
  map = new naver.maps.Map('map', {
    center: new naver.maps.LatLng(35.8393, 129.2279), // 경주 중심 좌표
    zoom: 12
  });

  if (navigator.geolocation) {// 사용자 위치 정보를 가져올 수 있는 경우
    navigator.geolocation.getCurrentPosition(onSuccessGeolocation, onErrorGeolocation);// 사용자 위치 정보를 가져옴
  } else {
    var center = map.getCenter();// 지도 중심 좌표를 얻어옴
    setMapCenter(center);
  }
}

function onSuccessGeolocation(position) {// 사용자 위치 정보를 가져오는 데 성공한 경우
  userLocation = new naver.maps.LatLng(position.coords.latitude, position.coords.longitude);// 사용자의 위치 정보를 저장
  setMapCenter(userLocation);// 지도의 중심을 사용자의 위치로 설정
  fetchTouristSpots(userLocation);// 주변 관광지 정보를 가져옴
}

function onErrorGeolocation() {// 사용자 위치 정보를 가져오는 데 실패한 경우
  var center = map.getCenter();// 지도 중심 좌표를 얻어옴
  userLocation = center;// 사용자의 위치 정보를 지도 중심으로 설정
  setMapCenter(center);// 지도의 중심을 사용자의 위치로 설정
}

function setMapCenter(location) {// 지도의 중심을 설정하는 함수
  map.setCenter(location);// 지도의 중심을 location으로 설정
  var marker = new naver.maps.Marker({// 마커를 생성
    position: location,// 마커의 위치
    map: map,// 마커를 표시할 지도
    icon: {
      content: '<div style="background-color:red;width:20px;height:20px;border-radius:50%;"></div>',// 마커의 모양을 설정
      anchor: new naver.maps.Point(10, 10)// 마커의 중심을 설정
    }
  });
}

async function fetchTouristSpots(location) {// 주변 관광지 정보를 가져오는 함수
  const apiUrl = "http://apis.data.go.kr/5050000/dstrctsTrrsrtService/getDstrctsTrrsrt";// API 주소
  const params = {
    serviceKey: "0OqIh/dSuVpGLLplebEorV4PTg6OC2ht/iiVg0ZabhBfKsX2EJwtAoizU3JjdH/uNz6G/800CT8f6YWfbI8v6w==",// API 키
    pageNo: "1",// 페이지 번호
    numOfRows: "164",// 한 번에 가져올 관광지의 개수
    type: "json"// JSON 형식으로 가져옴
  };

  try {
    const response = await fetch(`${apiUrl}?${new URLSearchParams(params)}`);// API를 호출하고 응답을 받음
    if (!response.ok) {// 응답이 성공적이지 않은 경우
      throw new Error("API 호출 실패: " + response.status);// 응답이 성공적이지 않은 경우 에러를 발생시킴
    }
    const data = await response.json();// 응답을 JSON 형식으로 변환
    console.log("API 응답:", data);// API 응답을 출력
    if (data.response && data.response.body && data.response.body.items) {// API 응답이 예상대로 온 경우
      displayTouristSpots(data.response.body.items.item);// 주변 관광지 정보를 출력
    } else {
      console.error("예상치 못한 API 응답 구조:", data);// API 응답이 예상대로 오지 않은 경우 에러를 출력
    }
  } catch (error) {// API 호출이 실패한 경우
    console.error("Error fetching tourist spots:", error);// 에러를 출력
  }
}

function displayTouristSpots(spots) {// 주변 관광지 정보를 출력하는 함수
  const listElement = document.getElementById('tourist-spots-list');// 관광지 정보를 출력할 요소를 가져옴
  listElement.innerHTML = '<h3>주변 여행지</h3>';
  const ul = document.createElement('ul');

  if (!Array.isArray(spots)) {
    console.error("spots is not an array:", spots);
    return;
  }

  // 거리 계산 및 정렬
  const spotsWithDistance = spots.map(spot => {
    const lat = parseFloat(spot.CON_LATITUDE);
    const lng = parseFloat(spot.CON_LONGITUDE);
    let distance = Infinity;
    if (!isNaN(lat) && !isNaN(lng) && userLocation) {
      distance = calculateDistance(userLocation, lat, lng);
    }
    return { ...spot, distance };
  }).sort((a, b) => a.distance - b.distance);

  // 상위 10개만 선택
  const nearestSpots = spotsWithDistance.slice(0, 10);

  nearestSpots.forEach((spot) => {
    const li = document.createElement('li');
    const spotName = spot.CON_TITLE || "이름 없음";
    const distanceText = spot.distance === Infinity ? "거리 정보 없음" : `${spot.distance.toFixed(2)} km`;
    li.textContent = `${spotName} (거리: ${distanceText})`;
    ul.appendChild(li);

    if (spot.distance !== Infinity) {
      const position = new naver.maps.LatLng(spot.CON_LATITUDE, spot.CON_LONGITUDE);
      const marker = new naver.maps.Marker({
        position: position,
        map: map
      });
      markers.push(marker);

      naver.maps.Event.addListener(marker, 'click', function() {
        map.setCenter(position);
        map.setZoom(14);
      });
    }
  });

  listElement.appendChild(ul);
}

function calculateDistance(userLoc, lat2, lon2) {
  const R = 6371; // 지구의 반경 (km)
  const dLat = deg2rad(lat2 - userLoc.lat());
  const dLon = deg2rad(lon2 - userLoc.lng());
  const a = 
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(deg2rad(userLoc.lat())) * Math.cos(deg2rad(lat2)) * 
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  const distance = R * c; // 거리 (km)
  return distance;
}

function deg2rad(deg) {
  return deg * (Math.PI/180);
}

window.onload = initMap;
</script> -->
{% endblock %}